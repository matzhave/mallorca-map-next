name: 🚀 Deploy to Staging

on:
  push:
    branches:
      - main

env:
  SERVER_HOST: 49.13.205.128
  SERVER_USER: root
  DEPLOY_PATH: /app/mallorca-map-next

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📋 Checkout code
        uses: actions/checkout@v4

      - name: 🔑 Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "SSH key setup complete"

      - name: 🚀 Deploy to Server
        run: |
          export SERVER_HOST="${{ env.SERVER_HOST }}"
          export SERVER_USER="${{ env.SERVER_USER }}"
          export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          
          ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new -o ConnectTimeout=10 $SERVER_USER@$SERVER_HOST << 'DEPLOY_EOF'
          set -e
          
          echo "📋 Deploying Mallorca Map Staging..."
          echo ""
          
          # Navigate to app directory
          cd /app/mallorca-map-next
          
          # Git Pull
          echo "📥 Pulling latest code from GitHub..."
          git pull origin main
          echo "✅ Code pulled"
          echo ""
          
          # Dependencies
          echo "📦 Installing dependencies..."
          bun install
          echo "✅ Dependencies installed"
          echo ""
          
          # Build (uses existing .env.local on server)
          echo "🔨 Building application..."
          bun run build
          echo "✅ Build successful"
          echo ""
          
          # Setup PM2 if not already installed
          echo "🔧 Ensuring PM2 is installed..."
          npm install -g pm2 2>&1 || true
          
          # Restart Service with PM2
          echo "🔄 Restarting service with PM2..."
          cd apps/web
          pm2 stop mallorca-map || true
          pm2 delete mallorca-map || true
          pm2 start "bun run start" --name mallorca-map --max-memory-restart 500M
          pm2 save
          echo "✅ Service restarted"
          echo ""
          
          # Configure Nginx
          echo "🌐 Configuring Nginx..."
          cd /app/mallorca-map-next
          sudo cp deploy/nginx-staging.conf /etc/nginx/sites-available/mallorca-map-staging
          sudo ln -sf /etc/nginx/sites-available/mallorca-map-staging /etc/nginx/sites-enabled/
          echo "✅ Nginx config updated"
          echo ""
          
          # Test and reload Nginx
          echo "🌐 Testing and reloading Nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          echo "✅ Nginx reloaded"
          echo ""
          
          # Health Check
          echo "🧪 Running health checks..."
          sleep 2
          if curl -s -u admin:9963 https://staging.mallorca-map.com/de | grep -q "Mallorca"; then
            echo "✅ Website is responsive!"
          else
            echo "⚠️  Website status check inconclusive"
          fi
          echo ""
          echo "🎉 Deployment completed successfully!"
          DEPLOY_EOF

      - name: ✅ Deployment Success
        if: success()
        run: |
          echo "✅ Staging deployment completed!"
          echo "🔗 URL: https://staging.mallorca-map.com"
          echo "🔐 Username: admin / Password: 9963"

      - name: ❌ Deployment Failed
        if: failure()
        run: |
          echo "❌ Deployment failed! Check logs above."
          exit 1
