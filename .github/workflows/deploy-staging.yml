name: ğŸš€ Deploy to Staging

on:
  push:
    branches:
      - main

env:
  SERVER_HOST: 49.13.205.128
  SERVER_USER: root
  DEPLOY_PATH: /app/mallorca-map-next

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "SSH key setup complete"

      - name: ğŸš€ Deploy to Server
        run: |
          export SERVER_HOST="${{ env.SERVER_HOST }}"
          export SERVER_USER="${{ env.SERVER_USER }}"
          export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          
          ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new -o ConnectTimeout=10 $SERVER_USER@$SERVER_HOST << 'DEPLOY_EOF'
          set -e
          
          echo "ğŸ“‹ Deploying Mallorca Map Staging..."
          echo ""
          
          # Navigate to app directory
          cd /app/mallorca-map-next
          
          # Git Pull
          echo "ğŸ“¥ Pulling latest code from GitHub..."
          git pull origin main
          echo "âœ… Code pulled"
          echo ""
          
          # Dependencies
          echo "ğŸ“¦ Installing dependencies..."
          bun install
          echo "âœ… Dependencies installed"
          echo ""
          
          # Build (uses existing .env.local on server)
          echo "ğŸ”¨ Building application..."
          bun run build
          echo "âœ… Build successful"
          echo ""
          
          # Setup PM2 if not already installed
          echo "ğŸ”§ Ensuring PM2 is installed..."
          npm install -g pm2 2>&1 || true
          
          # Restart Service with PM2
          echo "ğŸ”„ Restarting service with PM2..."
          cd apps/web
          pm2 stop mallorca-map || true
          pm2 delete mallorca-map || true
          pm2 start "bun run start" --name mallorca-map --max-memory-restart 500M
          pm2 save
          echo "âœ… Service restarted"
          echo ""
          
          # Configure Nginx
          echo "ğŸŒ Configuring Nginx..."
          cd /app/mallorca-map-next
          sudo cp deploy/nginx-staging.conf /etc/nginx/sites-available/mallorca-map-staging
          sudo ln -sf /etc/nginx/sites-available/mallorca-map-staging /etc/nginx/sites-enabled/
          echo "âœ… Nginx config updated"
          echo ""
          
          # Test and reload Nginx
          echo "ğŸŒ Testing and reloading Nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          echo "âœ… Nginx reloaded"
          echo ""
          
          # Health Check
          echo "ğŸ§ª Running health checks..."
          sleep 2
          if curl -s -u admin:9963 https://staging.mallorca-map.com/de | grep -q "Mallorca"; then
            echo "âœ… Website is responsive!"
          else
            echo "âš ï¸  Website status check inconclusive"
          fi
          echo ""
          echo "ğŸ‰ Deployment completed successfully!"
          DEPLOY_EOF

      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "âœ… Staging deployment completed!"
          echo "ğŸ”— URL: https://staging.mallorca-map.com"
          echo "ğŸ” Username: admin / Password: 9963"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check logs above."
          exit 1
