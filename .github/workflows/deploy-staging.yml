name: 🚀 Deploy to Staging

on:
  push:
    branches:
      - main

env:
  SERVER_HOST: 49.13.205.128
  SERVER_USER: root
  DEPLOY_PATH: /app/mallorca-map-next

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📋 Checkout code
        uses: actions/checkout@v4

      - name: 🔑 Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null

      - name: 🚀 Deploy to Server
        run: |
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
          set -e
          
          echo "📋 Deploying Mallorca Map Staging..."
          echo ""
          
          # Navigate to app directory
          cd $DEPLOY_PATH
          
          # Git Pull
          echo "📥 Pulling latest code from GitHub..."
          git pull origin main
          echo "✅ Code pulled"
          echo ""
          
          # Dependencies
          echo "📦 Installing dependencies..."
          bun install
          echo "✅ Dependencies installed"
          echo ""
          
          # Build
          echo "🔨 Building application..."
          bun run build
          echo "✅ Build successful"
          echo ""
          
          # Restart Service
          echo "🔄 Restarting service..."
          sudo systemctl restart mallorca-map-staging
          echo "✅ Service restarted"
          echo ""
          
          # Reload Nginx
          echo "🌐 Reloading Nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          echo "✅ Nginx reloaded"
          echo ""
          
          # Health Check
          echo "🧪 Running health checks..."
          sleep 2
          if curl -s -u staging:9963 https://staging.mallorca-map.com/de | grep -q "Willkommen"; then
            echo "✅ Website is responsive!"
          else
            echo "⚠️  Website status check inconclusive"
          fi
          echo ""
          echo "🎉 Deployment completed successfully!"
          EOF

      - name: ✅ Deployment Success
        if: success()
        run: |
          echo "✅ Staging deployment completed!"
          echo "🔗 URL: https://staging.mallorca-map.com"
          echo "🔐 Username: staging / Password: 9963"

      - name: ❌ Deployment Failed
        if: failure()
        run: |
          echo "❌ Deployment failed! Check logs above."
          exit 1
