name: ðŸš€ Deploy to Staging

on:
  push:
    branches:
      - main

env:
  SERVER_HOST: 49.13.205.128
  SERVER_USER: root
  DEPLOY_PATH: /app/mallorca-map-next

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‹ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null

      - name: ðŸš€ Deploy to Server
        run: |
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
          set -e
          
          echo "ðŸ“‹ Deploying Mallorca Map Staging..."
          echo ""
          
          # Navigate to app directory
          cd $DEPLOY_PATH
          
          # Git Pull
          echo "ðŸ“¥ Pulling latest code from GitHub..."
          git pull origin main
          echo "âœ… Code pulled"
          echo ""
          
          # Dependencies
          echo "ðŸ“¦ Installing dependencies..."
          bun install
          echo "âœ… Dependencies installed"
          echo ""
          
          # Build
          echo "ðŸ”¨ Building application..."
          bun run build
          echo "âœ… Build successful"
          echo ""
          
          # Restart Service
          echo "ðŸ”„ Restarting service..."
          sudo systemctl restart mallorca-map-staging
          echo "âœ… Service restarted"
          echo ""
          
          # Reload Nginx
          echo "ðŸŒ Reloading Nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          echo "âœ… Nginx reloaded"
          echo ""
          
          # Health Check
          echo "ðŸ§ª Running health checks..."
          sleep 2
          if curl -s -u staging:9963 https://staging.mallorca-map.com/de | grep -q "Willkommen"; then
            echo "âœ… Website is responsive!"
          else
            echo "âš ï¸  Website status check inconclusive"
          fi
          echo ""
          echo "ðŸŽ‰ Deployment completed successfully!"
          EOF

      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "âœ… Staging deployment completed!"
          echo "ðŸ”— URL: https://staging.mallorca-map.com"
          echo "ðŸ” Username: staging / Password: 9963"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check logs above."
          exit 1
